#include <stdio.h>
#include <stdlib.h>
#include <string.h>

char *name = NULL;
char *command = NULL;
char allow[] = "1234567890";

int read_input_raw(char *buf,int max_len);

int change(char **buf,char *check)
{
	int i,len;
	char tmp[100] = {0};
	read_input_raw(tmp,100);
	len = strlen(tmp);
	if(check != NULL)
	{
		for(i=0;i<len;i++)
		{
			if(!strchr(check,tmp[i]))
			{
				return 0;	
			}
		}
	}
	if(len>0)
		*buf = (char *)malloc(len+1);
	else
		return 0;
	memset(*buf,0,len+1);
	memcpy(*buf,tmp,len);
	return 1;
}

void menu()
{
	printf("Can you use 0~1 to pwn me?\n");
	printf("1).new name\n");
	printf("2).new command\n");
	printf("3).exec command\n");
	printf("4).clean\n");
	printf("5).exit\n");
}


int main()
{
	char input[2] = {0};
	char buffer[10] = {0};
	setvbuf(stdout,NULL,_IONBF,0);
	puts("What's your name?");
	change(&name,NULL);
	printf("Hello, %s\n",name);
	
	while(1)
	{
		menu();
		read_input_raw(input,2);
		switch(input[0]){
		case '1':
			puts("What's your name?");
			if(!change(&name,NULL))
			{
				exit(-1);
			}
			printf("Hello, %s\n",name);
			break;
		case '2':
			puts("What's your command?");
			if(!change(&command,allow))
			{
				printf("You can only use 0~9\n");
				break;
			}
			printf("your command is %s\n",command);
			break;
		case '3':
			system(command);
			break;
		case '4':
			free(name);
			free(command);
			break;
		case '5':
			exit(0);
		defualt:
			printf("Error input\n");
			break;
		};
	}
	return 0;
}

int read_input_raw(char *buf,int max_len)
{
	int i=0;
	int sz_read;
	char tmp;
	for (i=0;i<max_len;i++)
	{
		sz_read = read(0,&tmp,1);
		if(sz_read == -1)
			exit(-1);
		if(sz_read == 0)
		{
			break;
		}
		if(sz_read != 1)
			exit(-1);
		if (tmp == '\n' || tmp == '\r')
			break;
		buf[i] = tmp;
	}
	return i;
}
