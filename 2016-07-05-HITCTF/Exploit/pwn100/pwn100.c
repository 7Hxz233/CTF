#include <stdio.h>
#include <stdlib.h>
#include <time.h>

int read_input_raw(char *buf,int max_len);
void show_flag()
{
	char flag[50] = {0};
	FILE *fp = fopen("./flag","r");
	if(fp == NULL)
	{
		puts("fail to open file.");
		exit(-1);
	}
	fread(flag,1,50,fp);
	printf("You win! Here is the flag: %s\n",flag);
	fflush(stdout);
}


int main()
{
	int num;
	char buffer[12] = {0};
	char *key = &buffer[10];
	setvbuf(stdout,NULL,_IONBF,0);

	srand(time(NULL));
	while(1)
	{
		*key = rand() % 256;
		printf("Guess what I'm thinking about?(0-255):\n");
		read_input_raw(buffer,10);
		num = atoi(buffer);
		printf("I'm thinging %u, and you guess %u\n",*key,num);
		if(num == *key)
		{
			show_flag();
			break;
		}
		printf("wrong!\n");
	}
	return 0;
}

int read_input_raw(char *buf,int max_len)
{
	int i=0;
	int sz_read;
	char tmp;
	for (i=0;i<=max_len;i++)
	{
		sz_read = read(0,&tmp,1);
		if(sz_read == -1)
			exit(-1);
		if(sz_read == 0)
		{
			break;
		}
		if(sz_read != 1)
			exit(-1);
		if (tmp == '\n')
			break;
		buf[i] = tmp;
	}
	return i;
}
